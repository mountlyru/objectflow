# Пример: Загрузка документа «Версия коммерческого договора» со справочником «Договоры контрагентов»

Пошаговое руководство по загрузке данных из Excel-файла в документ **«Версия соглашения (коммерческий договор)»** (1С:ERP / 1С:Комплексная автоматизация).

Этот пример демонстрирует **продвинутую загрузку**: документ и связанный с ним элемент справочника «Договоры контрагентов» создаются **за один проход** с помощью произвольного кода, записи объекта в коде и оборачивания всего процесса в **единую транзакцию**.

---

## Содержание

1. [Общая схема загрузки](#1-общая-схема-загрузки)
2. [Подготовка Excel-файла](#2-подготовка-excel-файла)
3. [Выбор типа объекта и загрузка файла](#3-выбор-типа-объекта-и-загрузка-файла)
4. [Настройка маппинга реквизитов документа](#4-настройка-маппинга-реквизитов-документа)
5. [Произвольный код: создание справочника «Договоры контрагентов»](#5-произвольный-код-создание-справочника-договоры-контрагентов)
6. [Настройка параметров загрузки](#6-настройка-параметров-загрузки)
7. [Запуск загрузки и проверка результатов](#7-запуск-загрузки-и-проверка-результатов)
8. [JSON-конфигурация настроек](#8-json-конфигурация-настроек)

---

## 1. Общая схема загрузки

В 1С:ERP документ «Версия коммерческого договора» связан со справочником «Договоры контрагентов». Обычно это требует двух отдельных загрузок. Но в данном примере мы используем **произвольный код**, чтобы в момент записи документа автоматически создать элемент справочника и привязать его.

**Принцип работы:**

```
┌─────────────────────────────────────┐
│  Excel-файл «Договоры.xlsx»         │
│  (единый источник данных)           │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────────┐
│           Единая транзакция                          │
│                                                      │
│  1. Маппинг реквизитов документа                     │
│     (из файла, значениями, предопределенные)         │
│                                                      │
│  2. Произвольный код (ПередЗаписью):                 │
│     ┌───────────────────────────────────────────┐    │
│     │  Создать элемент справочника              │    │
│     │  «ДоговорыКонтрагентов»                   │    │
│     │  Заполнить его реквизиты из документа     │    │
│     │  Записать справочник                      │    │
│     │  Присвоить ссылку реквизиту документа     │    │
│     └───────────────────────────────────────────┘    │
│                                                      │
│  3. Запись документа (в коде, не автоматически)      │
│                                                      │
│  Если ошибка → откат ВСЕЙ транзакции                 │
└──────────────────────────────────────────────────────┘
```

**Преимущества подхода:**
- **Один проход** — не нужно запускать загрузку дважды
- **Транзакция** — если что-то пойдет не так, откатятся и документ, и справочник
- **Запись в коде** — полный контроль над порядком записи объектов

---

## 2. Подготовка Excel-файла

Подготовьте файл `Договоры.xlsx` со следующей структурой (19 колонок):

| Дата | Номер | БанковскийСчет | БанковскийСчетКонтрагента | ВидДоговораУХ | ВидСоглашения | ГосударственныйКонтракт | ДатаНачалаДействия | ДатаОкончанияДействия | ВалютаВзаиморасчетов | Контрагент | ЗаполненыРеквизитыУчетаСМСП | ЗапретПлатежаВПрочихВалютах | Организация | Сумма | ОсновнаяВалютаПлатежей | ОсновнойПроект | ОсновнойЦФО | Ответственный |
|------|-------|----------------|---------------------------|---------------|---------------|--------------------------|--------------------|-----------------------|----------------------|------------|------------------------------|------------------------------|-------------|-------|------------------------|----------------|-------------|---------------|
| 27.09.2018 17:29:19 | r434563456 | | | С поставщиком | Договор с условием | | | | руб. | Юникредит банк | Да | Да | Трансформатор | 0 | руб. | | | Орлов Александр Владимирович |
| 02.11.2018 18:00:57 | ааа | | АКБ "СОЮЗ" (ОАО) (RUB) | С покупателем | Договор с условием | | | | руб. | Мастер- Холод | Да | Да | Транслятор | 0 | руб. | | | Орлов Александр Владимирович |
| 01.01.2018 0:00:00 | ггг | | АКБ "СОЮЗ" (ОАО) (RUB) | С покупателем | Договор с условием | | 01.01.2018 | 31.12.2018 | руб. | Мастер- Холод | Да | Да | Транслятор | 0 | руб. | | | Орлов Александр Владимирович |
| 02.11.2018 18:01:38 | 654 | | АКБ "СОЮЗ" (ОАО) (RUB) | С покупателем | Договор с условием | | | | руб. | Мастер- Холод | Да | Да | Транслятор | 10000 | руб. | | | Орлов Александр Владимирович |
| 15.11.2018 15:17:05 | 2 | МАСТЕР-БАНК, Стройснаб (RUB) | АО ЮНИКРЕДИТ БАНК (RUB) | С поставщиком | Договор с условием | | | | руб. | Юникредит банк | Да | Да | Стройснаб | 0 | руб. | | | Орлов Александр Владимирович |

> **Важно:** Данные начинаются со **2-й строки** (первая строка — заголовки). Файл содержит **10 строк** данных.

**Ключевые колонки:**
- **Дата** (колонка A) — дата и время создания договора
- **Номер** (колонка B) — номер договора, используется как наименование для печати
- **Контрагент** (колонка K) — наименование контрагента
- **Организация** (колонка N) — наименование организации
- **ВидДоговораУХ** (колонка E) — вид договора (С поставщиком / С покупателем)
- **ВалютаВзаиморасчетов** (колонка J) — валюта расчетов
- **БанковскийСчет** (колонка C) — банковский счет организации
- **БанковскийСчетКонтрагента** (колонка D) — банковский счет контрагента
- 
---

## 3. Выбор типа объекта и загрузка файла

1. Откройте веб-интерфейс ObjectFlow
2. Загрузите файл `Договоры.xlsx`
3. В выпадающем списке **«Тип объекта»** выберите: **Документ.ВерсияСоглашенияКоммерческийДоговор**

<img width="686" height="257" alt="image" src="https://github.com/user-attachments/assets/64e75eb3-1494-4f08-bd2b-d0f9f1245d63" />

---

## 4. Настройка маппинга реквизитов документа

### 4.1. Реквизиты из файла — простые типы

| Реквизит | Колонка файла | Тип данных | Описание |
|----------|---------------|------------|----------|
| Дата | Дата (колонка 0) | Дата | Дата и время создания |
| ДатаНачалаДействия | ДатаНачалаДействия (колонка 7) | Дата | Начало действия договора |
| ДатаОкончанияДействия | ДатаОкончанияДействия (колонка 8) | Дата | Окончание действия договора |
| Сумма | Сумма (колонка 14) | Число(15,2) | Сумма договора |
| ЗаполненыРеквизитыУчетаСМСП | ЗаполненыРеквизитыУчетаСМСП (колонка 11) | Булево | — |
| ЗапретПлатежаВПрочихВалютах | ЗапретПлатежаВПрочихВалютах (колонка 12) | Булево | — |
| НаименованиеДляПечати | Номер (колонка 1) | Строка(150) | Номер договора для печатных форм |

<img width="762" height="626" alt="image" src="https://github.com/user-attachments/assets/80df616d-5aa7-4422-a18e-a38c0b2ca3dd" />

### 4.2. Реквизиты из файла — ссылочные типы (поиск по наименованию)

| Реквизит | Колонка файла | Тип ссылки | Поиск по |
|----------|---------------|------------|----------|
| ВидСоглашения | ВидСоглашения (колонка 5) | ПеречислениеСсылка.ВидыСоглашений | Наименование |
| Организация | Организация (колонка 13) | СправочникСсылка.Организации | Наименование |
| Контрагент | Контрагент (колонка 10) | СправочникСсылка.Контрагенты | Наименование |
| ВидДоговораУХ | ВидДоговораУХ (колонка 4) | СправочникСсылка.ВидыДоговоровКонтрагентовУХ | Наименование |
| ВалютаВзаиморасчетов | ВалютаВзаиморасчетов (колонка 9) | СправочникСсылка.Валюты | Наименование |
| ОсновнаяВалютаПлатежей | ОсновнаяВалютаПлатежей (колонка 15) | СправочникСсылка.Валюты | Наименование |
| ГосударственныйКонтракт | ГосударственныйКонтракт (колонка 6) | СправочникСсылка.ГосударственныеКонтракты | Наименование |
| ОсновнойПроект | ОсновнойПроект (колонка 16) | СправочникСсылка.Проекты | Наименование |
| ОсновнойЦФО | ОсновнойЦФО (колонка 17) | СправочникСсылка.Организации | Наименование |
| Ответственный | Ответственный (колонка 18) | СправочникСсылка.Пользователи | Наименование |

<img width="746" height="787" alt="image" src="https://github.com/user-attachments/assets/6e1f3353-6e41-41da-9e6e-ef739671160c" />

### 4.3. Реквизиты с составным поиском (по нескольким свойствам)

#### Банковский счет организации

Поиск в справочнике **БанковскиеСчетаОрганизаций** по двум свойствам:

| Свойство поиска | Источник | Значение |
|-----------------|----------|----------|
| Владелец | Из маппинга (Организация, маппинг №1) | Ссылка на организацию |
| НомерСчета | Из файла (колонка 2) | Текстовое значение |

#### Банковский счет контрагента

Поиск в справочнике **БанковскиеСчетаКонтрагентов** по двум свойствам:

| Свойство поиска | Источник | Значение |
|-----------------|----------|----------|
| Владелец | Из маппинга (Контрагент, маппинг №2) | Ссылка на контрагента |
| НомерСчета | Из файла (колонка 3) | Текстовое значение |

> Составной поиск гарантирует, что банковский счет принадлежит именно нужной организации или контрагенту.

<img width="738" height="115" alt="image" src="https://github.com/user-attachments/assets/b1c37175-186a-4faa-8b5e-32aab56734fe" />
<img width="739" height="92" alt="image" src="https://github.com/user-attachments/assets/15327df8-7e48-485d-a9dc-30fdb2236da8" />

### 4.4. Реквизиты, заполняемые фиксированным значением

| Реквизит | Значение | Описание |
|----------|----------|----------|
| КратностьПлатежа | `1` | Кратность валюты платежа |
| НДСПоСтавкам4и2 | `Ложь` | Не использовать ставки 4% и 2% |

<img width="781" height="661" alt="image" src="https://github.com/user-attachments/assets/c5f974db-e65e-4a7c-b84b-876df37ec89d" />

### 4.5. Реквизиты, заполняемые предопределенным значением

| Реквизит | Предопределенное значение | Описание |
|----------|---------------------------|----------|
| СпособРасчетаКоличестваДней | Календарные дни | Способ расчета дней в периоде |
| ВариантКурсаДоговораУХ | Переменный | Курс валюты в договоре |

<img width="772" height="772" alt="image" src="https://github.com/user-attachments/assets/952c16f9-3783-4dba-a196-a50320ec67e0" />

---

## 5. Произвольный код: создание справочника «Договоры контрагентов»

Это **ключевая особенность** данного примера. В разделе **«Произвольный код»** настройки загрузки добавляется алгоритм, который:

1. Создает новый элемент справочника «ДоговорыКонтрагентов»
2. Заполняет его реквизиты из уже заполненного документа
3. Записывает справочник
4. Привязывает ссылку на созданный договор к документу
5. Записывает сам документ

### Код алгоритма (событие «ПередЗаписью»)

```1c
// Доступные переменные:
// Объект — документ ВерсияСоглашенияКоммерческийДоговор

// 1. Создаем новый элемент справочника «Договоры контрагентов»
МенеджерДоговора = УправлениеДоговорамиУХВызовСервераПовтИсп.ПолучитьМенеджерСправочникаДоговора(Объект.ВидДоговораУХ);
ДоговорОбъект = МенеджерДоговора.СоздатьЭлемент();

// 2. Заполняем реквизиты из документа
РеквизитыИсключения = "Ссылка,ПометкаУдаления";
ЗаполнитьЗначенияСвойств(ДоговорОбъект, Объект,, РеквизитыИсключения); 
			
МетаданныеВерсииСоглашения = Объект.Метаданные();
МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоПолномуИмени(МетаданныеВерсииСоглашения.ПолноеИмя());
Объект.ДополнительныеСвойства.Вставить("ДоговорОбъект", ДоговорОбъект);      
Объект.ДополнительныеСвойства.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
ВычисляемыеПоляДоговора = МенеджерОбъекта.ВычисляемыеРеквизитыДоговора(Объект);
ЗаполнитьЗначенияСвойств(ДоговорОбъект, ВычисляемыеПоляДоговора);
					
Если УправлениеДоговорамиУХКлиентСерверПовтИсп.ЭтоДоговорСПокупателем(Объект.ВидДоговораУХ)
	И Не ЗначениеЗаполнено(Объект.ГосударственныйКонтракт)
  И ЗначениеЗаполнено(ДоговорОбъект.Номер) И ЗначениеЗаполнено(ДоговорОбъект.Дата) Тогда	
    ПараметрыДоговора = Новый Структура("Ссылка,Номер,Дата", 
				Справочники.ДоговорыКонтрагентов.ПустаяСсылка(), ДоговорОбъект.Номер, ДоговорОбъект.Дата);
    ИдентификаторПлатежа = ДоговорыКонтрагентовФормыУХВызовСервера.ПолучитьИдентификаторПлатежаНаСервере(ПараметрыДоговора);
    Если Не ПустаяСтрока(ИдентификаторПлатежа) Тогда
      ДоговорОбъект.ИдентификаторПлатежа = ИдентификаторПлатежа;  
    КонецЕсли;
КонецЕсли;
ДоговорОбъект.ДополнительныеСвойства.Вставить("ЭтоЗаписьИзВерсииСоглашения", Истина);    

// 3. Записываем справочник
ДоговорОбъект.Записать();                    

// 4. Привязываем созданный договор к документу
Если Не ЗначениеЗаполнено(Объект.Ссылка) Тогда
  ДоговорОбъект.ВерсияСоглашения = МенеджерОбъекта.ПолучитьСсылку();
  Объект.УстановитьСсылкуНового(ДоговорОбъект.ВерсияСоглашения);     
КонецЕсли;

// 5. Записываем документ
Объект.Записать();
```
<img width="760" height="316" alt="image" src="https://github.com/user-attachments/assets/ddb57e60-ef08-480b-ab61-2f982ec02c24" />

### Как это работает

```
Для каждой строки Excel:
  ┌───────────────────────────────────────────────────┐
  │  Начало транзакции                                │
  │                                                   │
  │  1. ObjectFlow заполняет реквизиты документа      │
  │     по маппингу (из файла, значениями и т.д.)     │
  │                                                   │
  │  2. Вызывается произвольный код «ПередЗаписью»:   │
  │     • Создается элемент ДоговорыКонтрагентов      │
  │     • Реквизиты копируются из документа           │
  │     • Справочник записывается                     │
  │     • Ссылка присваивается документу              │
  │     • Документ записывается                       │
  │                                                   │
  │  3. ObjectFlow НЕ записывает объект автоматически │
  │     (режим записи = «в коде»)                     │
  │                                                   │
  │  Фиксация транзакции                              │
  └───────────────────────────────────────────────────┘
```

> **Важно:** Режим записи объекта установлен в **«В коде»**. Это означает, что ObjectFlow **не записывает** документ автоматически после заполнения реквизитов — запись выполняется внутри произвольного кода вызовом `Записать()`.

### Зачем записывать в коде?

В обычном режиме ObjectFlow сначала заполняет реквизиты, а потом автоматически записывает объект. Но в нашем случае нужно:

1. **До записи документа** — создать и записать элемент справочника
2. **Присвоить ссылку** справочника реквизиту документа
3. **Только потом** — записать документ

Если бы запись была автоматической, документ записался бы **без** ссылки на договор, потому что справочник ещё не существовал бы в момент записи.

---

## 6. Настройка параметров загрузки

| Параметр | Значение | Описание |
|----------|----------|----------|
| Группировка строк | Нет | Каждая строка — отдельный документ |
| Лист Excel | Первый лист (индекс 0) | — |
| Начальная строка | 2 | Пропуск строки заголовков |
| Режим обновления | Создавать новые объекты | Если документ существует — все равно создаем новый|
| **Режим записи** | **В коде** | Запись объекта выполняется в произвольном коде |
| Обязательные поля | Пропускать | Строки с незаполненными обязательными полями пропускаются |
| **Использовать транзакцию** | **Да** | Все объекты записываются в одной транзакции |
| Режим разработчика | Нет | — |

### Почему «В коде»?

Режим записи **«В коде»** означает, что ObjectFlow заполняет реквизиты документа по маппингу, но **не вызывает** `Записать()` автоматически. Вместо этого запись происходит внутри произвольного кода, где вы полностью контролируете порядок операций.

### Почему транзакция?

Включение **транзакции** гарантирует атомарность: если при создании справочника или записи документа произойдет ошибка, **оба объекта** будут откатаны. Без транзакции может возникнуть ситуация, когда справочник создан, а документ — нет (или наоборот).

<img width="773" height="1081" alt="image" src="https://github.com/user-attachments/assets/c1558608-b620-4893-96c1-73d0f3c555f9" />

---

## 7. Запуск загрузки и проверка результатов

### Порядок действий

1. Убедитесь, что все маппинги настроены корректно
2. Убедитесь, что произвольный код добавлен в раздел **«Произвольный код»**
3. Убедитесь, что режим записи — **«В коде»**, транзакция — **Да**
4. Нажмите кнопку **«Загрузить»**
5. Проверьте лог загрузки

### Ожидаемый результат

После загрузки для каждой строки Excel будут созданы **два объекта**:

**1. Элемент справочника «Договоры контрагентов»:**

| Наименование | Контрагент | Организация | Вид договора |
|-------------|------------|-------------|--------------|
| r434563456 | Юникредит банк | Трансформатор | С поставщиком |
| ааа | Мастер- Холод | Транслятор | С покупателем |
| ггг | Мастер- Холод | Транслятор | С покупателем |
| 654 | Мастер- Холод | Транслятор | С покупателем |
| 2 | Юникредит банк | Стройснаб | С поставщиком |

**2. Документ «Версия коммерческого договора»** (пример одного):
- Дата: 27.09.2018 17:29:19
- Наименование для печати: r434563456
- Организация: Трансформатор
- Контрагент: Юникредит банк
- **Договор контрагента: r434563456** (ссылка на созданный справочник)
- Вид договора: С поставщиком
- Вид соглашения: Договор с условием
- Валюта взаиморасчетов: руб.
- Сумма: 0
- Ответственный: Орлов Александр Владимирович

<img width="1254" height="859" alt="image" src="https://github.com/user-attachments/assets/5feb3670-9ebd-4f86-8416-2e4c46e4e0eb" />

---
## Особенности данного примера

### Загрузка за один проход с произвольным кодом

В отличие от двухэтапного подхода, здесь **не нужно** запускать загрузку дважды. Произвольный код в событии **«ПередЗаписью»** создает элемент справочника и привязывает его к документу прямо в процессе загрузки.

### Запись объекта в коде

Режим "Записывать в коде" отключает автоматическую запись документа после заполнения реквизитов. Это позволяет:
- Создать и записать зависимый объект (справочник) **до** записи документа
- Присвоить ссылку на справочник реквизиту документа
- Записать документ в нужный момент

### Единая транзакция

Параметр "Изменять в транзакции" оборачивает **всю** загрузку в одну транзакцию. Если при обработке любой строки произойдет ошибка:
- Откатятся **все** созданные справочники
- Откатятся **все** созданные документы
- База данных вернется в исходное состояние

Это гарантирует целостность данных: не может возникнуть ситуация, когда часть договоров загружена, а часть — нет.

### Составной поиск банковских счетов

Банковские счета ищутся по **двум свойствам**: номеру счета из файла и владельцу из другого маппинга:

```
БанковскийСчет организации:
  Владелец = маппинг «Организация» (№1)
  НомерСчета = колонка «БанковскийСчет» (№2) из файла

БанковскийСчет контрагента:
  Владелец = маппинг «Контрагент» (№2)
  НомерСчета = колонка «БанковскийСчетКонтрагента» (№3) из файла
```

---

## Частые вопросы

### Чем отличается режим записи «В коде» от «Автоматический»?

| | Автоматический | В коде |
|---|---|---|
| Кто записывает объект | ObjectFlow | Ваш произвольный код |
| Когда вызывается `Записать()` | После заполнения всех реквизитов | Когда вы решите |
| Можно создать другие объекты до записи | Нет | Да |
| Подходит для связанных объектов | Нет | Да |

### Что будет, если произвольный код вызовет ошибку?

При включенной транзакции "Изменять в транзакции" все изменения откатятся. Если транзакция выключена — уже записанные объекты останутся в базе, а текущий и последующие будут пропущены с ошибкой в логе.

### Можно ли использовать `СтрокаДанных` в произвольном коде?

Да, но только для заполнения конкретного реквизита. Переменная `СтрокаДанных` содержит текущую строку из Excel-файла и позволяет обращаться к значениям колонок напрямую, если данных из маппинга недостаточно. 

### Что делать, если контрагент или организация не найдены?

Убедитесь, что в базе 1С существуют элементы справочников «Контрагенты» и «Организации» с точно такими же наименованиями, как в Excel-файле. Поиск выполняется по точному совпадению номера счета.




